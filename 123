#!/usr/bin/env bash
set -euo pipefail

ALLOW_TCP_PORTS=("22" "443" "9443")

SYN_PER_IP_RATE="30/second"
SYN_PER_IP_BURST="60"
SYN_GLOBAL_RATE="5000/second"
SYN_GLOBAL_BURST="10000"
DROP_UDP_443="1"

ENABLE_FAIL2BAN="1"
FAIL2BAN_BANTIME="1h"
FAIL2BAN_FINDTIME="10m"
FAIL2BAN_MAXRETRY="5"
FAIL2BAN_IGNOREIP="127.0.0.1/8 ::1"

have_cmd() { command -v "$1" >/dev/null 2>&1; }

require_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    echo "run as root"
    exit 1
  fi
}

install_pkg_apt() {
  local package_name="$1"
  apt-get update -y
  apt-get install -y "$package_name"
}

install_nftables() {
  if have_cmd nft; then
    return 0
  fi
  if have_cmd apt-get; then
    install_pkg_apt nftables
  else
    echo "apt-get not found; install nftables manually"
    exit 1
  fi
}

install_fail2ban() {
  if [[ "${ENABLE_FAIL2BAN}" != "1" ]]; then
    return 0
  fi
  if have_cmd fail2ban-client; then
    return 0
  fi
  if have_cmd apt-get; then
    install_pkg_apt fail2ban
  else
    echo "apt-get not found; install fail2ban manually"
    exit 1
  fi
}

backup_rules() {
  mkdir -p /root
  local timestamp
  timestamp="$(date +%F_%H%M%S)"
  echo "[*] backup current ruleset -> /root/nft.ruleset.bak.${timestamp}.txt"
  nft list ruleset > "/root/nft.ruleset.bak.${timestamp}.txt" || true

  if [[ -f /etc/nftables.conf ]]; then
    echo "[*] backup /etc/nftables.conf -> /root/nftables.conf.bak.${timestamp}"
    cp -a /etc/nftables.conf "/root/nftables.conf.bak.${timestamp}"
  fi
}

write_nft_config() {
  local ports_lines=""
  for tcp_port in "${ALLOW_TCP_PORTS[@]}"; do
    ports_lines+=$'    tcp dport '"${tcp_port}"$' accept\n'
  done

  local udp443_rule=""
  if [[ "${DROP_UDP_443}" == "1" ]]; then
    udp443_rule=$'    udp dport 443 counter drop\n'
  fi

  cat > /etc/nftables.conf <<EOF
flush ruleset

table inet ddos {
  chain pre {
    type filter hook prerouting priority raw; policy accept;

${udp443_rule}    tcp dport 443 tcp flags syn counter meter syn443v4 { ip saddr limit rate over ${SYN_PER_IP_RATE} burst ${SYN_PER_IP_BURST} packets } drop
    tcp dport 443 tcp flags syn counter meter syn443v6 { ip6 saddr limit rate over ${SYN_PER_IP_RATE} burst ${SYN_PER_IP_BURST} packets } drop
    tcp dport 443 tcp flags syn counter limit rate over ${SYN_GLOBAL_RATE} burst ${SYN_GLOBAL_BURST} packets drop
  }
}

table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    iif lo accept

    ct state invalid drop
    ct state established,related accept

    ip protocol icmp accept
    ip6 nexthdr ipv6-icmp accept

${ports_lines}  }

  chain forward {
    type filter hook forward priority 0; policy drop;
    ct state established,related accept
    iifname "docker0" accept
    iifname "br-*" accept
  }

  chain output {
    type filter hook output priority 0; policy accept;
  }
}
EOF
}

apply_nft() {
  systemctl enable --now nftables >/dev/null 2>&1 || true
  nft -f /etc/nftables.conf
  systemctl restart nftables >/dev/null 2>&1 || true
}

pick_fail2ban_action() {
  if [[ -f /etc/fail2ban/action.d/nftables-multiport.conf ]]; then
    echo "nftables-multiport"
    return
  fi
  if [[ -f /etc/fail2ban/action.d/iptables-multiport.conf ]]; then
    echo "iptables-multiport"
    return
  fi
  echo "iptables-multiport"
}

configure_fail2ban() {
  if [[ "${ENABLE_FAIL2BAN}" != "1" ]]; then
    return 0
  fi

  mkdir -p /etc/fail2ban/jail.d
  mkdir -p /run/fail2ban
  touch /var/log/fail2ban.log || true

  local banaction
  banaction="$(pick_fail2ban_action)"

  cat > /etc/fail2ban/jail.d/00-antidd.conf <<EOF
[DEFAULT]
ignoreip = ${FAIL2BAN_IGNOREIP}
bantime = ${FAIL2BAN_BANTIME}
findtime = ${FAIL2BAN_FINDTIME}
maxretry = ${FAIL2BAN_MAXRETRY}
banaction = ${banaction}

[sshd]
enabled = true
port = 22
mode = aggressive
backend = systemd
EOF

  systemctl enable --now fail2ban >/dev/null 2>&1 || true
  systemctl restart fail2ban >/dev/null 2>&1 || true

  set +e
  fail2ban-client ping >/dev/null 2>&1
  local ping_status=$?
  set -e

  if [[ "${ping_status}" -ne 0 ]]; then
    echo "[*] fail2ban failed to start; showing diagnostics"
    systemctl status fail2ban --no-pager -l || true
    journalctl -u fail2ban -n 200 --no-pager || true
    return 0
  fi
}

show_status() {
  echo
  echo "[*] nft rules (ddos pre):"
  nft -a list chain inet ddos pre || true

  echo
  echo "[*] nft input allowlist:"
  nft -a list chain inet filter input || true

  echo
  echo "[*] listening ports (non-localhost):"
  ss -lntup | awk 'NR==1 || $4 !~ /(127\.0\.0\.1|::1)/' || true

  if have_cmd fail2ban-client; then
    echo
    echo "[*] fail2ban status:"
    fail2ban-client status || true
  fi

  echo
  echo "[*] done"
  echo "rollback: nft -f /root/nft.ruleset.bak.<TIMESTAMP>.txt"
}

main() {
  require_root
  install_nftables
  install_fail2ban
  backup_rules
  write_nft_config
  apply_nft
  configure_fail2ban
  show_status
}

main "$@"
