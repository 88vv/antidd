#!/usr/bin/env bash
set -euo pipefail

# ====== CONFIG (можешь менять под себя) ======
ALLOW_TCP_PORTS=("22" "443" "9443")

# rate-limit SYN на 443 (per-IP)
SYN_PER_IP_RATE="30/second"
SYN_PER_IP_BURST="60"

# глобальный предохранитель SYN на 443
SYN_GLOBAL_RATE="5000/second"
SYN_GLOBAL_BURST="10000"

# если UDP на 443 тебе не нужен (обычно для VLESS+Reality не нужен) -> 1
DROP_UDP_443="1"

# автоприбить сервисы, которые слушают лишнее (опционально)
STOP_CADDY="0"
STOP_ZABBIX="0"
# ============================================

require_root() {
  if [[ "${EUID:-$(id -u)}" -ne 0 ]]; then
    echo "run as root"
    exit 1
  fi
}

have_cmd() { command -v "$1" >/dev/null 2>&1; }

disable_ufw_if_active() {
  if have_cmd ufw; then
    if ufw status 2>/dev/null | grep -qi "Status: active"; then
      echo "[*] ufw active -> disabling"
      ufw disable || true
    fi
  fi
}

install_nftables() {
  if have_cmd nft; then
    return 0
  fi

  if have_cmd apt-get; then
    echo "[*] installing nftables"
    apt-get update -y
    apt-get install -y nftables
  else
    echo "apt-get not found; install nftables manually"
    exit 1
  fi
}

backup_rules() {
  mkdir -p /root
  local ts
  ts="$(date +%F_%H%M%S)"
  echo "[*] backup current ruleset -> /root/nft.ruleset.bak.${ts}.txt"
  nft list ruleset > "/root/nft.ruleset.bak.${ts}.txt" || true

  if [[ -f /etc/nftables.conf ]]; then
    echo "[*] backup /etc/nftables.conf -> /root/nftables.conf.bak.${ts}"
    cp -a /etc/nftables.conf "/root/nftables.conf.bak.${ts}"
  fi
}

write_config() {
  local ports_line=""
  for port in "${ALLOW_TCP_PORTS[@]}"; do
    ports_line+=$'    tcp dport '"${port}"$' accept\n'
  done

  local udp443_rule=""
  if [[ "${DROP_UDP_443}" == "1" ]]; then
    udp443_rule=$'    udp dport 443 counter drop\n'
  fi

  cat > /etc/nftables.conf <<EOF
flush ruleset

table inet ddos {
  chain pre {
    type filter hook prerouting priority -300; policy accept;

${udp443_rule}    tcp dport 443 tcp flags syn counter meter syn443v4 { ip saddr limit rate over ${SYN_PER_IP_RATE} burst ${SYN_PER_IP_BURST} packets } drop
    tcp dport 443 tcp flags syn counter meter syn443v6 { ip6 saddr limit rate over ${SYN_PER_IP_RATE} burst ${SYN_PER_IP_BURST} packets } drop
    tcp dport 443 tcp flags syn counter limit rate over ${SYN_GLOBAL_RATE} burst ${SYN_GLOBAL_BURST} packets drop
  }
}

table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    iif lo accept

    ct state invalid drop
    ct state established,related accept

    ip protocol icmp accept
    ip6 nexthdr icmpv6 accept

${ports_line}  }

  chain forward {
    type filter hook forward priority 0; policy drop;

    ct state established,related accept

    iifname "docker0" accept
    iifname "br-*" accept
  }

  chain output {
    type filter hook output priority 0; policy accept;
  }
}
EOF
}

apply_rules() {
  echo "[*] enabling nftables service"
  systemctl enable --now nftables >/dev/null 2>&1 || true

  echo "[*] applying rules from /etc/nftables.conf"
  nft -f /etc/nftables.conf

  systemctl restart nftables >/dev/null 2>&1 || true
}

optional_stop_services() {
  if [[ "${STOP_CADDY}" == "1" ]]; then
    echo "[*] stopping caddy"
    systemctl disable --now caddy 2>/dev/null || true
  fi

  if [[ "${STOP_ZABBIX}" == "1" ]]; then
    echo "[*] stopping zabbix-agent"
    systemctl disable --now zabbix-agent zabbix-agent2 2>/dev/null || true
  fi
}

show_status() {
  echo
  echo "[*] nft rules (ddos pre):"
  nft -a list chain inet ddos pre || true

  echo
  echo "[*] nft input allowlist:"
  nft -a list chain inet filter input || true

  echo
  echo "[*] listening ports (non-localhost):"
  ss -lntup | awk 'NR==1 || $4 !~ /(127\.0\.0\.1|::1)/' || true

  echo
  echo "[*] done"
  echo "rollback: nft -f /root/nft.ruleset.bak.<TIMESTAMP>.txt"
}

main() {
  require_root
  disable_ufw_if_active
  install_nftables
  backup_rules
  write_config
  apply_rules
  optional_stop_services
  show_status
}

main "$@"
